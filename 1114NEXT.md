# 次に進む具体的な方向性（優先度順）— Cursor 共有用

本ドキュメントは、現在の実装状況を踏まえ、**最小ラインを堅牢化 → 精度向上 → データセット化 → 横展開 → 将来互換**の順に進めるための手順書です。  
※ FreeSewing は **v3系（@freesewing/simon）** 前提。**v4への自動アップグレードはしない**方針です（アダプタ層で吸収）。

---

## A. マッピングv1の確定＆自動テスト導入（最優先）

### 目的
- **壊れない最小ライン**をまず“テストで守る”。

### 作業
1. `data/mapping.simon.features.v1.json` を現行の抽出IDで一旦FIX（コミットタグ化）。
2. **しきい値テスト**を追加（`node:test` でOK）：
   - **サイズ妥当性**：`front_length_mm / back_length_mm / sleeve_length_mm / hem_circum_mm` で **M < L** が成立。
   - **体型差の符号**：`NEKOSE` は **front_length_mm が短め / back_length_mm が長め**（NOSHAPE比較で符号チェック）。
3. npmスクリプトを追加：
   ```json
   {
     "scripts": {
       "test": "npm run build && node --test dist/tests/**/*.js",
       "test:features:simon": "npm run test -- -t simon"
     }
   }
   ```

### 受け入れ基準
- `npm run test:features:simon` が **グリーン**。
- マッピング更新で数値が崩れた場合、**テストが落ちて気づける**。

---

## B. 視覚デバッグ（オーバーレイSVG）でID選定を高速化

### 目的
- どの **path/point** を測っているかを**一目で可視化**し、マッピング精度改善の反復を高速化。

### 作業
1. `src/tools/overlaySvg.ts` を追加（抽出に使った path を色付きで上書き描画し、`*_debug.svg` を出力）。
2. npmスクリプト：
   ```json
   {
     "scripts": {
       "overlay:simon": "npm run build && node dist/tools/overlaySvg.js --in output/simon_*.svg --map data/mapping.simon.features.v1.json --out output/_debug"
     }
   }
   ```

### 受け入れ基準
- `output/_debug/*.svg` が生成され、**対象パーツの輪郭がハイライト**される。
- 目視でマッピングの良し悪しが判断できる。

---

## C. Feature抽出の精度アップ（段階アップグレード）

### 目的
- **学習で使える信頼性**のある数値へ。

### 作業ステップ
1. **周長系（hem_circum_mm など）**は **対象 path の合算長**で計算（`svg-path-properties`）。
2. **直線距離系（shoulder_seam_length_mm など）**は **代表点間距離**で計算（将来の point id に備え、`mapping`へ `point_id`s を導入予定）。
3. **前丈/後丈**は **前中心/後中心の上端〜裾端**（Y方向の端点）を測るルールに統一。

### 受け入れ基準
- bbox近似からの逸脱を解消し、**意図した幾何値**になっている（オーバーレイと数値の一致を目視確認）。
- サイズ差・体型差に対する**数値の一貫性**がテストで担保される。

---

## D. データセット化（集計CSV/JSONL・データカード・再現手順）

### 目的
- **学習にすぐ投げられる形**で成果物を束ねる。

### 作業
1. `src/tools/summarizeFeatures.ts` を追加（`/output` 配下を走査 → `features_summary.csv` / `samples.jsonl` 生成）。
2. `dataset.v1/` ディレクトリに以下をまとめる：
   - `features_summary.csv`（1行=1サンプルのフラットテーブル）
   - `samples.jsonl`（メタ＋featuresの行指向JSON）
   - `DATASET_CARD.md`（対象・スキーマ・単位・生成条件・既知の限界・推奨用途）
   - **再現手順**（使用コマンド一覧）

### 受け入れ基準
- `dataset.v1/` が**自己完結**しており、第三者が手順通りに再生成できる。

---

## E. パターン横展開（同スキーマで広げる）

### 目的
- **スキーマは共通**のままパターンを増やし、**データの多様性**を獲得。

### 候補
- **Carlton**（ジャケット/コート系：裾形状・ベント・ラペル起点など新規featureが測れる）
- **Brian系他トップス**（同ブロック系列での整合検証）

### 作業
1. 新パターンの npm 依存を追加（例：`@freesewing/carlton`）。
2. `data/mapping.{pattern}.features.v1.json` を作成（既存抽出器で通す）。
3. **4サンプル最小グリッド**（M/L × 2シェイプ）で検証 → テスト追加。

### 受け入れ基準
- 既存スキーマで**そのまま抽出・集計が通る**（テストとサマリーがグリーン）。

---

## F. FreeSewing v4 への移行準備（中期）

### 目的
- 将来のAPI変更に備え、**アダプタ層**で差分吸収。

### 作業
1. `src/freesewing/adapter.ts` を作成し、**“v3の使い方”をここに閉じ込める**。
2. v4試験ブランチで最小ドラフト → SVG が通るか検証（本線は v3 のまま）。

### 受け入れ基準
- v3/v4切替が **アダプタ差し替え**で済む構成が確認できる。

---

## 補足：現在の前提と禁止事項（Cursor向け）

- **前提**
  - FreeSewing は **v3** パッケージで利用（`@freesewing/simon`）。
  - 単位は **mm** で統一（meta/measurements/features すべて）。
  - `introspectSvg` → `extractFromSvg` → `overlaySvg` → `summarize` の**一連のパス**は維持。

- **禁止事項**
  - FreeSewing の **v4 API へ自動リファクタ**しない。
  - `mapping.*.json` のキー名やスキーマを**テストが無い状態で変更**しない。

---

## 推奨コマンド（まとめ）

```bash
# 1) ビルド
npm run build

# 2) features テスト（しきい値・符号チェック）
npm run test:features:simon

# 3) オーバーレイSVG生成（ハイライト付き）
npm run overlay:simon

# 4) データセット集計（CSV/JSONL + データカード雛形）
npm run summarize
```

---

## 進め方（短冊）

1. **A（テスト）→ B（オーバーレイ）** で最小ラインを堅牢化  
2. **C（精度アップ）** で抽出ロジックを段階的に高精度化  
3. **D（データセット化）** で学習投入可能な塊に  
4. **E（横展開）** でスキーマ互換のまま他パターンへ  
5. **F（v4準備）** で将来変更に強い構造へ
